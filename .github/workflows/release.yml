name: Release

on:
  release:
    types: [published]

jobs:
  discover-charts:
    name: Discover charts
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Build matrix from charts/ directory
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Find chart directories containing Chart.yaml directly under charts/
          charts_json=$(
            find charts -mindepth 1 -maxdepth 1 -type d \
              -exec test -f "{}/Chart.yaml" \; -print \
            | sed 's|^charts/||' \
            | sort \
            | jq -R -s -c 'split("\n") | map(select(length>0))'
          )

          echo "Discovered charts: ${charts_json}"
          echo "matrix=${charts_json}" >> "$GITHUB_OUTPUT"

  package-and-release:
    name: Package & Upload (${{ matrix.chart }})
    runs-on: ubuntu-latest
    needs: discover-charts

    permissions:
      contents: write
      packages: write

    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJson(needs.discover-charts.outputs.matrix) }}

    env:
      TAG: ${{ github.ref_name }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Install helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: v3.18.4

      - name: Package helm chart
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          CHART="${{ matrix.chart }}"

          # Force the chart version to match the GitHub release tag
          # This makes the output dist/<chart>-<TAG>.tgz
          helm package "charts/${CHART}" \
            --version "${TAG}" \
            --app-version "${TAG}" \
            --destination dist

      - name: Upload packaged chart as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: chart-${{ matrix.chart }}
          path: |
            dist/*.tgz
          if-no-files-found: error

      - name: Upload release files (per chart)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tgz

  publish-gh-pages:
    name: Publish Helm repo to gh-pages
    runs-on: ubuntu-latest
    needs: package-and-release
    if: github.event.release.prerelease == false

    permissions:
      contents: write

    steps:
      - name: Install helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: v3.19.0

      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download all packaged chart artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Copy charts and update index.yaml
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p gh-pages/charts

          # Copy all tgz and prov files from all artifacts
          find artifacts -type f \( -name "*.tgz" -o -name "*.tgz.prov" \) -print -exec cp -v {} gh-pages/charts/ \;

          cd gh-pages/charts
          helm repo index . --url https://sourcehawk.github.io/sample-helm-charts/charts

      - name: Set up Git
        shell: bash
        run: |
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global user.name "github-actions"

      - name: Push updated Helm repo to gh-pages
        shell: bash
        run: |
          set -euo pipefail
          cd gh-pages
          git add charts
          git commit -m "Update Helm repo for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin gh-pages
